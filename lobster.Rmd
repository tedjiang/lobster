---
title: "lobster"
author: "Yingfei Jiang"
date: "11/12/2018"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

library(tidyverse)
library(vcdExtra)
library(ggpubr)
library(car)
library(onewaytests)
library(kableExtra)
#Loading packages

lob_a_draft <- read_csv("lobster_size_abundance.csv")
lob_t_draft <- read_csv("lobster_traps.csv")

```


```{r, include = FALSE}

#Some basic data wrangling in this chunk, column lob_year is for future use when plotting trend, here i am assuming fishing season "x-x+1" is counted as year x+1. This means when we analyze trap count in the future, it is the trap count before the lobster count of the same year, which is collected in August  

lob_a_draft <- as.data.frame(lob_a_draft) #coerce to data.frame
lob_a <- expand.dft(lob_a_draft, freq = "COUNT") #get the data into case format


lob_t <- lob_t_draft %>% 
  mutate(
    lob_year = case_when(
      FISHING_SEASON == "2012-2013" ~ 2013,
      FISHING_SEASON == "2013-2014" ~ 2014,
      FISHING_SEASON == "2014-2015" ~ 2015,
      FISHING_SEASON == "2015-2016" ~ 2016,
      FISHING_SEASON == "2016-2017" ~ 2017
    )
  )

```
Comment about trends, events, differences


```{r, message=FALSE, echo = FALSE, warning = FALSE}

#Plotting trend in lobster count and trap count

#lob_a_trend stores lobster counts based on year and site
lob_a_trend <- lob_a %>%
  group_by(YEAR, SITE) %>%
  summarize(lob_counts = length(SIZE))

#lob_t_trend stores total observed trap counts through the fishing season by year and location, this doesnt necessarily make sense since observations are made on selected days.
lob_t_trend <- lob_t %>%
  filter (
    SITE == "AQUE" |
    SITE == "NAPL" |
    SITE == "MOHK" |
    SITE == "IVEE" |
    SITE == "CARP"
    ) %>% 
  group_by(lob_year, SITE) %>% 
  summarize(trap_counts = sum(TRAPS)) %>% 
  #summarize(trap_counts = round(mean(TRAPS), 2)) %>% 
  rename(YEAR = lob_year)

trend <- full_join(lob_a_trend, lob_t_trend)

trend_plot <- ggplot(trend) +
  geom_line(aes(x = YEAR, y = lob_counts, color = "Lobster Counts")) +
  geom_line(aes(x = YEAR - 0.5, y = trap_counts, color = "Trap Counts")) +
  scale_y_continuous(sec.axis = sec_axis(~., name = "Trap Counts")) +
  facet_wrap(~SITE, scale = "free") +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10)) +
  labs(x = "Year",
       y = "Lobster Counts",
       colour = "Counts")
  

trend_plot

```

```{r, message=FALSE, echo = FALSE}

#Visualization for lobster size at five sites, we need to decide which plot is better
#The second one!
lob_a_2017 <- lob_a %>%
  filter(YEAR == 2017)

lob_a_2017_box <- ggplot(lob_a_2017, aes(SITE, SIZE)) +
  geom_boxplot(width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.2, aes(color = SITE)) +
  theme_pubr() +
  labs(x = "Site",
       y = "Carapace Length (mm)")

lob_a_2017_box

sum_2017 <- lob_a_2017 %>% 
  group_by(SITE) %>% 
  summarize(
    lob_mean = round(mean(SIZE), 2),
    lob_sd = round(sd(SIZE), 2),
    lob_count = length(SIZE),
    lob_var = round(var(SIZE), 2)
    ) %>% 
  mutate(lob_size = paste(as.character(lob_mean), " Â± ", as.character(lob_sd)))

#Output table we will use in the report
tbl_2017 <- sum_2017 %>% 
  select(SITE, lob_size, lob_count) %>% 
  kable(col.names = c("Site  \n\n","Size  \n$(mm)$", "Sample  \nSize"), #Assigning column names
        align = "c") %>% 
  kable_styling(bootstrap_options = c("hover", "condensed"), 
                full_width = FALSE, 
                position = "left") %>% 
  column_spec(1, bold = T, background = "cornsilk") %>% 
  row_spec(0, background = "cornsilk")

tbl_2017

lob_a_2017_column <- ggplot(sum_2017, aes(x = SITE, y = lob_mean)) +
  geom_col(color = "black", fill = "gray", width = 0.7) +
  geom_errorbar(aes(ymin = lob_mean - lob_sd, ymax = lob_mean + lob_sd), width = 0.3) +
  theme_pubr() +
  labs(x = "Site",
       y = "Carapace Length (mm)") +
  expand_limits(y = c(0, 120)) +
  scale_y_continuous(expand = c(0, 0))

lob_a_2017_column

```

```{r, include = FALSE}

#Data exploration

histos <- ggplot(lob_a_2017, aes(SIZE)) +
  geom_histogram(bins = 20) +
  facet_wrap(~SITE, scale = "free")

histos

qqs <- ggplot(lob_a_2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~SITE, scale = "free")

qqs

#Normal distribution

```


```{r, include = FALSE}

#One-way ANOVA test
#Post-hoc test

lob_2017_levene <- leveneTest(SIZE ~ SITE, data = lob_a_2017)

lob_2017_levene
#levene's test rejects equal variances

lob_2017_aov <- aov.test(SIZE ~ SITE, data = lob_a_2017)
lob_2017_aov

lob_2017_ph <- paircomp(lob_2017_aov, adjust.method = "bonferroni")
lob_2017_ph

```

